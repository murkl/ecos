kind: pipeline
type: docker
name: ecos pipeline

platform:
  os: linux
  arch: arm64

volumes:
  - name: dockersock
    host:
      path: /var/run/docker.sock

steps:
  - name: create docker image
    image: plugins/docker
    settings:
      dockerfile: ./Dockerfile
      registry: zeus:5000
      repo: zeus:5000/ecos
      insecure: true
      force_tag: true
      cache_from: "zeus:5000/ecos:latest"
      tags:
        - latest

  - name: remove container
    image: docker:dind
    failure: ignore
    volumes:
      - name: dockersock
        path: /var/run/docker.sock
    commands:
      - sleep 5 # give docker enough time to start up
      - docker rm -f ecos

  - name: deploy container
    image: docker:dind
    volumes:
      - name: dockersock
        path: /var/run/docker.sock
    commands:
      - sleep 5 # give docker enough time to start up
      - docker pull zeus:5000/ecos:latest
      - docker run -d --name ecos -p 80:80 --restart=always zeus:5000/ecos:latest
